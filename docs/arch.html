<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"></head><body class="vsc-initialized"><h1 id="nmslite---architecture-document">NMSlite - Architecture
Document</h1>
<blockquote>
<p><strong>Version:</strong> 1.0.0<br>
<strong>Last Updated:</strong> December 2024<br>
<strong>Status:</strong> Design Phase</p>
</blockquote>
<hr>
<h2 id="table-of-contents">Table of Contents</h2>
<ol type="1">
<li><a href="#1-overview">Overview</a></li>
<li><a href="#2-system-context">System Context</a></li>
<li><a href="#3-high-level-architecture">High-Level
Architecture</a></li>
<li><a href="#4-service-architecture">Service Architecture</a></li>
<li><a href="#5-data-architecture">Data Architecture</a></li>
<li><a href="#6-message-queue-architecture">Message Queue
Architecture</a></li>
<li><a href="#7-caching-architecture">Caching Architecture</a></li>
<li><a href="#8-security-architecture">Security Architecture</a></li>
<li><a href="#9-api-specification">API Specification</a></li>
<li><a href="#10-configuration">Configuration</a></li>
<li><a href="#11-technology-stack">Technology Stack</a></li>
<li><a href="#12-non-functional-requirements">Non-Functional
Requirements</a></li>
</ol>
<hr>
<h2 id="overview">1. Overview</h2>
<h3 id="purpose">1.1 Purpose</h3>
<p>NMSlite is a lightweight Network Monitoring System designed to
monitor <strong>Windows machines</strong>, collecting performance
metrics (CPU, memory, disk, network, optionally processes) via WMI/WinRM
protocols.</p>
<h3 id="high-level-goals">1.2 High-Level Goals</h3>
<table>
<colgroup>
<col style="width: 13%">
<col style="width: 27%">
<col style="width: 59%">
</colgroup>
<thead>
<tr class="header">
<th>#</th>
<th>Goal</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><strong>JWT-Secured API</strong></td>
<td>Production-minded HTTP API server secured with JWT</td>
</tr>
<tr class="even">
<td>2</td>
<td><strong>CRUD Operations</strong></td>
<td>Credential profiles, device discovery, monitor provisioning</td>
</tr>
<tr class="odd">
<td>3</td>
<td><strong>Windows Metrics</strong></td>
<td>Collect disk, memory, CPU, network (optionally processes)</td>
</tr>
<tr class="even">
<td>4</td>
<td><strong>Event-Driven</strong></td>
<td>Message queue for decoupling discovery, polling, storage</td>
</tr>
<tr class="odd">
<td>5</td>
<td><strong>Caching</strong></td>
<td>Cache device metadata, credentials to reduce DB load</td>
</tr>
<tr class="even">
<td>6</td>
<td><strong>API-First</strong></td>
<td>Query device details via Postman (clear spec + examples)</td>
</tr>
<tr class="odd">
<td>7</td>
<td><strong>Plugin Collectors</strong></td>
<td>Plugin-style polling modules for extensibility</td>
</tr>
<tr class="even">
<td>8</td>
<td><strong>Testable</strong></td>
<td>Include tests (Phase 2)</td>
</tr>
</tbody>
</table>
<h3 id="scope">1.3 Scope</h3>
<p><strong>In Scope:</strong> - CRUD for credential profiles (WMI/WinRM)
- Device discovery and inventory management - Monitor provisioning via
APIs - Windows metrics collection (CPU, memory, disk, network,
processes) - Event-driven architecture with message queue - Caching
layer for frequently accessed data - JWT authentication with HTTPS/TLS -
Structured logging - Plugin-style collector architecture - Postman
collection for API testing</p>
<p><strong>Out of Scope (v1.0):</strong> - Linux/SSH monitoring - Web UI
/ Dashboard - Alerting system - Multi-tenancy - SNMP monitoring</p>
<hr>
<h2 id="system-context">2. System Context</h2>
<h3 id="context-diagram">2.1 Context Diagram</h3>
<pre><code>                                    ┌─────────────────┐
                                    │    API Client   │
                                    │    (Postman)    │
                                    └────────┬────────┘
                                             │
                                             │ HTTPS + JWT
                                             ▼
┌──────────────────────────────────────────────────────────────────────┐
│                             NMSlite                                  │
│                                                                      │
│  ┌───────────┐    ┌───────────┐    ┌───────────┐    ┌───────────┐    │
│  │  REST API │    │  Message  │    │  Polling  │    │  Storage  │    │
│  │  Server   │───▶│   Queue   │───▶│  Workers  │───▶│  Writer   │    │
│  └───────────┘    └───────────┘    └───────────┘    └───────────┘    │
│        │                                                  │          │
│        │          ┌───────────┐                           │          │
│        └─────────▶│   Cache   │◀──────────────────────────┘          │
│                   └───────────┘                                      │
│                                                                      │
│                   ┌───────────┐                                      │
│                   │ PostgreSQL│                                      │
│                   └───────────┘                                      │
└──────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ WMI / WinRM
                                    ▼
                            ┌───────────────┐
                            │    Windows    │
                            │    Targets    │
                            └───────────────┘</code></pre>
<h3 id="external-interfaces">2.2 External Interfaces</h3>
<table>
<thead>
<tr class="header">
<th>System</th>
<th>Protocol</th>
<th>Port</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Windows Targets</td>
<td>WMI</td>
<td>135 + dynamic</td>
<td>Legacy Windows metrics</td>
</tr>
<tr class="even">
<td>Windows Targets</td>
<td>WinRM HTTP</td>
<td>5985</td>
<td>Modern Windows metrics</td>
</tr>
<tr class="odd">
<td>Windows Targets</td>
<td>WinRM HTTPS</td>
<td>5986</td>
<td>Secure Windows metrics</td>
</tr>
<tr class="even">
<td>API Clients</td>
<td>HTTPS</td>
<td>8443</td>
<td>REST API access</td>
</tr>
<tr class="odd">
<td>PostgreSQL</td>
<td>TCP</td>
<td>5432</td>
<td>Data persistence</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="high-level-architecture">3. High-Level Architecture</h2>
<h3 id="architecture-style">3.1 Architecture Style</h3>
<p><strong>Event-Driven Modular Monolith</strong></p>
<ul>
<li>Single deployable binary with internal service boundaries</li>
<li>Message queue for decoupling components</li>
<li>Asynchronous processing for scalability</li>
</ul>
<h3 id="component-overview">3.2 Component Overview</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                              NMSlite Binary                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                           HTTP Layer                                   │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────────┐    │ │
│  │  │   Router   │  │    JWT     │  │    TLS     │  │  Rate Limiter  │    │ │
│  │  │   (chi)    │  │ Middleware │  │ Middleware │  │  Middleware    │    │ │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────────┘    │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                          API Handlers                                  │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────────┐    │ │
│  │  │    Auth    │  │   Device   │  │ Credential │  │    Metrics     │    │ │
│  │  │  Handler   │  │  Handler   │  │  Handler   │  │    Handler     │    │ │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────────┘    │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         Service Layer                                  │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────────┐    │ │
│  │  │    Auth    │  │   Device   │  │ Credential │  │    Metrics     │    │ │
│  │  │  Service   │  │  Service   │  │  Service   │  │    Service     │    │ │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────────┘    │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│          ┌───────────────────────────┼───────────────────────────┐          │
│          │                           │                           │          │
│          ▼                           ▼                           ▼          │
│  ┌──────────────┐          ┌─────────────────┐          ┌──────────────┐    │
│  │    Cache     │          │  Message Queue  │          │  Repository  │    │
│  │  (In-Memory) │          │                 │          │    Layer     │    │
│  └──────────────┘          └────────┬────────┘          └──────────────┘    │
│                                     │                           │           │
│                                     ▼                           │           │
│  ┌───────────────────────────────────────────────────────────┐  │           │
│  │                      Worker Pool                          │  │           │
│  │  ┌─────────────────────────────────────────────────────┐  │  │           │
│  │  │              Collector Registry (Plugin)            │  │  │           │
│  │  │  ┌───────────┐  ┌───────────┐  ┌───────────────┐    │  │  │           │
│  │  │  │    WMI    │  │   WinRM   │  │    Future     │    │  │  │           │
│  │  │  │ Collector │  │ Collector │  │   Plugins     │    │  │  │           │
│  │  │  └───────────┘  └───────────┘  └───────────────┘    │  │  │           │
│  │  └─────────────────────────────────────────────────────┘  │  │           │
│  └───────────────────────────────────────────────────────────┘  │           │
│                                     │                           │           │
│                                     ▼                           ▼           │
│                            ┌──────────────┐           ┌──────────────┐      │
│                            │   Storage    │──────────▶│  PostgreSQL  │      │
│                            │   Writer     │           │              │      │
│                            └──────────────┘           └──────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="data-flow">3.3 Data Flow</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                              Request Flow                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. API Request (Provision Device)                                          │
│     ┌────────┐      ┌─────────┐      ┌─────────────┐      ┌─────────┐       │
│     │ Client │─────▶│   API   │─────▶│   Service   │─────▶│   DB    │       │
│     └────────┘      └─────────┘      └──────┬──────┘      └─────────┘       │
│                                             │                               │
│                                             ▼                               │
│  2. Publish Poll Job                  ┌─────────────┐                       │
│                                       │    Queue    │                       │
│                                       │ (poll_jobs) │                       │
│                                       └──────┬──────┘                       │
│                                              │                              │
│                                              ▼                              │
│  3. Worker Consumes Job               ┌─────────────┐                       │
│                                       │   Worker    │                       │
│                                       └──────┬──────┘                       │
│                                              │                              │
│                                              ▼                              │
│  4. Collect Metrics                   ┌─────────────┐      ┌─────────┐      │
│                                       │  Collector  │─────▶│ Windows │      │
│                                       │  (WMI/WinRM)│◀─────│  Target │      │
│                                       └──────┬──────┘      └─────────┘      │
│                                              │                              │
│                                              ▼                              │
│  5. Publish Metrics                   ┌─────────────┐                       │
│                                       │    Queue    │                       │
│                                       │ (metrics)   │                       │
│                                       └──────┬──────┘                       │
│                                              │                              │
│                                              ▼                              │
│  6. Store Metrics                     ┌─────────────┐      ┌─────────┐      │
│                                       │   Storage   │─────▶│   DB    │      │
│                                       │   Writer    │      │         │      │
│                                       └─────────────┘      └─────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<hr>
<h2 id="service-architecture">4. Service Architecture</h2>
<h3 id="auth-service">4.1 Auth Service</h3>
<p><strong>Responsibility:</strong> JWT authentication and token
management</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> AuthService <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    Login<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> username<span class="op">,</span> password <span class="dt">string</span><span class="op">)</span> <span class="op">(*</span>TokenPair<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    RefreshToken<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> refreshToken <span class="dt">string</span><span class="op">)</span> <span class="op">(*</span>TokenPair<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    ValidateToken<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> accessToken <span class="dt">string</span><span class="op">)</span> <span class="op">(*</span>Claims<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> TokenPair <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    AccessToken  <span class="dt">string</span>    <span class="st">`json:"access_token"`</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    RefreshToken <span class="dt">string</span>    <span class="st">`json:"refresh_token"`</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    ExpiresAt    time<span class="op">.</span>Time <span class="st">`json:"expires_at"`</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Claims <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    UserID   <span class="dt">int</span>    <span class="st">`json:"user_id"`</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    Username <span class="dt">string</span> <span class="st">`json:"username"`</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    Role     <span class="dt">string</span> <span class="st">`json:"role"`</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr>
<h3 id="device-service">4.2 Device Service</h3>
<p><strong>Responsibility:</strong> Device CRUD and discovery</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> DeviceService <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// CRUD</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    Create<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> device <span class="op">*</span>CreateDeviceRequest<span class="op">)</span> <span class="op">(*</span>Device<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    GetByID<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> id <span class="dt">int</span><span class="op">)</span> <span class="op">(*</span>Device<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    List<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> filters <span class="op">*</span>DeviceFilters<span class="op">)</span> <span class="op">(*</span>DeviceList<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    Update<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> id <span class="dt">int</span><span class="op">,</span> req <span class="op">*</span>UpdateDeviceRequest<span class="op">)</span> <span class="op">(*</span>Device<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    Delete<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> id <span class="dt">int</span><span class="op">)</span> <span class="dt">error</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Discovery</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    Discover<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> req <span class="op">*</span>DiscoverRequest<span class="op">)</span> <span class="op">(*</span>DiscoverResult<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Provisioning (publishes to queue)</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    Provision<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> deviceID <span class="dt">int</span><span class="op">,</span> credentialID <span class="dt">int</span><span class="op">)</span> <span class="dt">error</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    Deprovision<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> deviceID <span class="dt">int</span><span class="op">)</span> <span class="dt">error</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Device <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    ID              <span class="dt">int</span>       <span class="st">`json:"id"`</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    IP              <span class="dt">string</span>    <span class="st">`json:"ip"`</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    Hostname        <span class="dt">string</span>    <span class="st">`json:"hostname"`</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    OS              <span class="dt">string</span>    <span class="st">`json:"os"`</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    Status          <span class="dt">string</span>    <span class="st">`json:"status"`</span>  <span class="co">// discovered, provisioned, monitoring, unreachable</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    PollingInterval <span class="dt">int</span>       <span class="st">`json:"polling_interval"`</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    LastSeen        time<span class="op">.</span>Time <span class="st">`json:"last_seen"`</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    CreatedAt       time<span class="op">.</span>Time <span class="st">`json:"created_at"`</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr>
<h3 id="credential-service">4.3 Credential Service</h3>
<p><strong>Responsibility:</strong> Secure credential management for
Windows auth</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> CredentialService <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    Create<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> cred <span class="op">*</span>CreateCredentialRequest<span class="op">)</span> <span class="op">(*</span>Credential<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    GetByID<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> id <span class="dt">int</span><span class="op">)</span> <span class="op">(*</span>Credential<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    List<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">)</span> <span class="op">([]</span>Credential<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    Update<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> id <span class="dt">int</span><span class="op">,</span> req <span class="op">*</span>UpdateCredentialRequest<span class="op">)</span> <span class="op">(*</span>Credential<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    Delete<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> id <span class="dt">int</span><span class="op">)</span> <span class="dt">error</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Internal use only (for polling)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    GetDecrypted<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> id <span class="dt">int</span><span class="op">)</span> <span class="op">(*</span>DecryptedCredential<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Credential <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    ID             <span class="dt">int</span>       <span class="st">`json:"id"`</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    Name           <span class="dt">string</span>    <span class="st">`json:"name"`</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    CredentialType <span class="dt">string</span>    <span class="st">`json:"credential_type"`</span>  <span class="co">// wmi, winrm_basic, winrm_ntlm</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    Username       <span class="dt">string</span>    <span class="st">`json:"username"`</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    Domain         <span class="dt">string</span>    <span class="st">`json:"domain,omitempty"`</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    Port           <span class="dt">int</span>       <span class="st">`json:"port,omitempty"`</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    UseSSL         <span class="dt">bool</span>      <span class="st">`json:"use_ssl"`</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    CreatedAt      time<span class="op">.</span>Time <span class="st">`json:"created_at"`</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Password never returned in API responses</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Credential Types:</strong></p>
<table>
<thead>
<tr class="header">
<th>Type</th>
<th>Auth Method</th>
<th>Default Port</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>wmi</code></td>
<td>NTLM</td>
<td>135</td>
<td>Legacy Windows servers</td>
</tr>
<tr class="even">
<td><code>winrm_basic</code></td>
<td>Basic Auth</td>
<td>5985/5986</td>
<td>Standalone Windows</td>
</tr>
<tr class="odd">
<td><code>winrm_ntlm</code></td>
<td>NTLM</td>
<td>5985/5986</td>
<td>Domain-joined Windows</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="metrics-service">4.4 Metrics Service</h3>
<p><strong>Responsibility:</strong> Metrics retrieval (read
operations)</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> MetricsService <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    GetLatest<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> deviceID <span class="dt">int</span><span class="op">)</span> <span class="op">(*</span>DeviceMetrics<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    GetHistory<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> deviceID <span class="dt">int</span><span class="op">,</span> req <span class="op">*</span>HistoryRequest<span class="op">)</span> <span class="op">(*</span>MetricsHistory<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> DeviceMetrics <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    DeviceID     <span class="dt">int</span>            <span class="st">`json:"device_id"`</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    Timestamp    time<span class="op">.</span>Time      <span class="st">`json:"timestamp"`</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    CPU          CPUMetrics     <span class="st">`json:"cpu"`</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    Memory       MemoryMetrics  <span class="st">`json:"memory"`</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    Disk         DiskMetrics    <span class="st">`json:"disk"`</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    Network      NetworkMetrics <span class="st">`json:"network"`</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    ProcessCount <span class="dt">int</span>            <span class="st">`json:"process_count"`</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> CPUMetrics <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    UsagePercent <span class="dt">float64</span> <span class="st">`json:"usage_percent"`</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> MemoryMetrics <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    TotalBytes   <span class="dt">int64</span>   <span class="st">`json:"total_bytes"`</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    UsedBytes    <span class="dt">int64</span>   <span class="st">`json:"used_bytes"`</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    UsagePercent <span class="dt">float64</span> <span class="st">`json:"usage_percent"`</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> DiskMetrics <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    TotalBytes   <span class="dt">int64</span>   <span class="st">`json:"total_bytes"`</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    UsedBytes    <span class="dt">int64</span>   <span class="st">`json:"used_bytes"`</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    UsagePercent <span class="dt">float64</span> <span class="st">`json:"usage_percent"`</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> NetworkMetrics <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    BytesSentPerSec   <span class="dt">int64</span>   <span class="st">`json:"bytes_sent_per_sec"`</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    BytesRecvPerSec   <span class="dt">int64</span>   <span class="st">`json:"bytes_recv_per_sec"`</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    UtilizationPercent <span class="dt">float64</span> <span class="st">`json:"utilization_percent"`</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    PacketsSent       <span class="dt">int64</span>   <span class="st">`json:"packets_sent"`</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    PacketsRecv       <span class="dt">int64</span>   <span class="st">`json:"packets_recv"`</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    Errors            <span class="dt">int64</span>   <span class="st">`json:"errors"`</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    Dropped           <span class="dt">int64</span>   <span class="st">`json:"dropped"`</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr>
<h3 id="polling-service-event-driven">4.5 Polling Service
(Event-Driven)</h3>
<p><strong>Responsibility:</strong> Orchestrate metric collection via
message queue</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> PollingService <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lifecycle</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    Start<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">)</span> <span class="dt">error</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    Stop<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">)</span> <span class="dt">error</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Queue consumers</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    HandlePollJob<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> job <span class="op">*</span>PollJob<span class="op">)</span> <span class="dt">error</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    HandleMetricsResult<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> result <span class="op">*</span>MetricsResult<span class="op">)</span> <span class="dt">error</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Message types</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> PollJob <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    JobID        <span class="dt">string</span>    <span class="st">`json:"job_id"`</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    DeviceID     <span class="dt">int</span>       <span class="st">`json:"device_id"`</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    CredentialID <span class="dt">int</span>       <span class="st">`json:"credential_id"`</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    ScheduledAt  time<span class="op">.</span>Time <span class="st">`json:"scheduled_at"`</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> MetricsResult <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    JobID     <span class="dt">string</span>         <span class="st">`json:"job_id"`</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    DeviceID  <span class="dt">int</span>            <span class="st">`json:"device_id"`</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    Timestamp time<span class="op">.</span>Time      <span class="st">`json:"timestamp"`</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    Success   <span class="dt">bool</span>           <span class="st">`json:"success"`</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    Error     <span class="dt">string</span>         <span class="st">`json:"error,omitempty"`</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    Metrics   <span class="op">*</span>DeviceMetrics <span class="st">`json:"metrics,omitempty"`</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr>
<h3 id="collector-interface-plugin-architecture">4.6 Collector Interface
(Plugin Architecture)</h3>
<p><strong>Responsibility:</strong> Pluggable metric collection</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Collector is the plugin interface for metric collection</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Collector <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Name returns the collector identifier</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    Name<span class="op">()</span> <span class="dt">string</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Supports checks if this collector can handle the credential type</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    Supports<span class="op">(</span>credentialType <span class="dt">string</span><span class="op">)</span> <span class="dt">bool</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Collect gathers metrics from the target device</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    Collect<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> target <span class="op">*</span>CollectorTarget<span class="op">)</span> <span class="op">(*</span>DeviceMetrics<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> CollectorTarget <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    IP         <span class="dt">string</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    Port       <span class="dt">int</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    Username   <span class="dt">string</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    Password   <span class="dt">string</span>  <span class="co">// Decrypted</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    Domain     <span class="dt">string</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    UseSSL     <span class="dt">bool</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    Timeout    time<span class="op">.</span>Duration</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Registry manages available collectors</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> CollectorRegistry <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    Register<span class="op">(</span>collector Collector<span class="op">)</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    Get<span class="op">(</span>credentialType <span class="dt">string</span><span class="op">)</span> <span class="op">(</span>Collector<span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    List<span class="op">()</span> <span class="op">[]</span><span class="dt">string</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Built-in Collectors:</strong></p>
<table>
<thead>
<tr class="header">
<th>Collector</th>
<th>Credential Types</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>WMICollector</code></td>
<td><code>wmi</code></td>
<td>Uses go-ole for WMI queries</td>
</tr>
<tr class="even">
<td><code>WinRMCollector</code></td>
<td><code>winrm_basic</code>, <code>winrm_ntlm</code></td>
<td>Uses WinRM protocol</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="data-architecture">5. Data Architecture</h2>
<h3 id="entity-relationship-diagram">5.1 Entity Relationship
Diagram</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                              AUTHENTICATION                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────────┐              ┌──────────────────────┐                │
│    │     users       │──────────────│   refresh_tokens     │                │
│    │                 │    1 : N     │                      │                │
│    │ id (PK)         │              │ id (PK)              │                │
│    │ username        │              │ user_id (FK)         │                │
│    │ password_hash   │              │ token_hash           │                │
│    │ role            │              │ expires_at           │                │
│    │ created_at      │              │ created_at           │                │
│    │ updated_at      │              └──────────────────────┘                │
│    └─────────────────┘                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                               INVENTORY                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────────────┐                    ┌─────────────────────┐       │
│    │    credentials      │                    │      devices        │       │
│    │                     │      N : N         │                     │       │
│    │ id (PK)             │◄──────────────────▶│ id (PK)             │       │
│    │ name                │                    │ ip                  │       │
│    │ credential_type     │  device_credentials│ hostname            │       │
│    │ username            │  ┌───────────────┐ │ os                  │       │
│    │ encrypted_password  │  │device_id (FK) │ │ status              │       │
│    │ domain              │  │cred_id (FK)   │ │ polling_interval    │       │
│    │ port                │  │priority       │ │ last_seen           │       │
│    │ use_ssl             │  │is_active      │ │ created_at          │       │
│    │ created_at          │  │last_success   │ │ updated_at          │       │
│    │ updated_at          │  └───────────────┘ │                     │       │
│    └─────────────────────┘                    └──────────┬──────────┘       │
│                                                          │                  │
└──────────────────────────────────────────────────────────┼──────────────────┘
                                                           │
                                                           │ 1 : N
                                                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           TIME-SERIES METRICS                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     metrics (unified table)                         │    │
│  │                   (partitioned by timestamp)                        │    │
│  │                  All values are system-wide aggregates              │    │
│  │                                                                     │    │
│  │  id (PK)                    - BIGSERIAL                             │    │
│  │  device_id (FK)             - INTEGER, references devices           │    │
│  │  timestamp                  - TIMESTAMPTZ                           │    │
│  │                                                                     │    │
│  │  -- CPU (system-wide) --                                            │    │
│  │  cpu_usage_percent          - NUMERIC(5,2)                          │    │
│  │                                                                     │    │
│  │  -- Memory (system-wide) --                                         │    │
│  │  memory_total_bytes         - BIGINT                                │    │
│  │  memory_used_bytes          - BIGINT                                │    │
│  │  memory_usage_percent       - NUMERIC(5,2)                          │    │
│  │                                                                     │    │
│  │  -- Disk (all drives combined) --                                   │    │
│  │  disk_total_bytes           - BIGINT                                │    │
│  │  disk_used_bytes            - BIGINT                                │    │
│  │  disk_usage_percent         - NUMERIC(5,2)                          │    │
│  │                                                                     │    │
│  │  -- Network (all interfaces combined) --                            │    │
│  │  net_bytes_sent_per_sec     - BIGINT                                │    │
│  │  net_bytes_recv_per_sec     - BIGINT                                │    │
│  │  net_utilization_percent    - NUMERIC(5,2)                          │    │
│  │  net_packets_sent           - BIGINT                                │    │
│  │  net_packets_recv           - BIGINT                                │    │
│  │  net_errors                 - BIGINT                                │    │
│  │  net_dropped                - BIGINT                                │    │
│  │                                                                     │    │
│  │  -- Process --                                                      │    │
│  │  process_count              - INTEGER                               │    │
│  │                                                                     │    │
│  │  -- Metadata --                                                     │    │
│  │  collection_duration_ms     - INTEGER                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="sql-schema">5.2 SQL Schema</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Users</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> users (</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    username <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">UNIQUE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    password_hash <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">role</span> <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="st">'operator'</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> NOW(),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    updated_at TIMESTAMPTZ <span class="kw">DEFAULT</span> NOW()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Refresh Tokens</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> refresh_tokens (</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    user_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> users(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    token_hash <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">UNIQUE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    expires_at TIMESTAMPTZ <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> NOW()</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- Credentials</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> credentials (</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    name <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    credential_type <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,  <span class="co">-- wmi, winrm_basic, winrm_ntlm</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    username <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    encrypted_password TEXT <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">domain</span> <span class="dt">VARCHAR</span>(<span class="dv">255</span>),</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    port <span class="dt">INTEGER</span>,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    use_ssl <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span>,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> NOW(),</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    updated_at TIMESTAMPTZ <span class="kw">DEFAULT</span> NOW(),</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CONSTRAINT</span> valid_cred_type <span class="kw">CHECK</span> (credential_type <span class="kw">IN</span> (<span class="st">'wmi'</span>, <span class="st">'winrm_basic'</span>, <span class="st">'winrm_ntlm'</span>))</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="co">-- Devices</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> devices (</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    ip <span class="dt">VARCHAR</span>(<span class="dv">45</span>) <span class="kw">UNIQUE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    hostname <span class="dt">VARCHAR</span>(<span class="dv">255</span>),</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    os <span class="dt">VARCHAR</span>(<span class="dv">255</span>),</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    status <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">DEFAULT</span> <span class="st">'discovered'</span>,</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    polling_interval <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">60</span>,</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    last_seen TIMESTAMPTZ,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> NOW(),</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    updated_at TIMESTAMPTZ <span class="kw">DEFAULT</span> NOW(),</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">CONSTRAINT</span> valid_status <span class="kw">CHECK</span> (status <span class="kw">IN</span> (<span class="st">'discovered'</span>, <span class="st">'provisioned'</span>, <span class="st">'monitoring'</span>, <span class="st">'unreachable'</span>))</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="co">-- Device-Credential Association</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> device_credentials (</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    device_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> devices(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span>,</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    credential_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> credentials(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span>,</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    priority <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">1</span>,</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    is_active <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">TRUE</span>,</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    last_success TIMESTAMPTZ,</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>    created_at TIMESTAMPTZ <span class="kw">DEFAULT</span> NOW(),</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">UNIQUE</span>(device_id, credential_id)</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a><span class="co">-- Unified Metrics Table (partitioned) - All values are system-wide aggregates</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> metrics (</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGSERIAL,</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>    device_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>    <span class="dt">timestamp</span> TIMESTAMPTZ <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> NOW(),</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- CPU (system-wide)</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>    cpu_usage_percent <span class="dt">NUMERIC</span>(<span class="dv">5</span>,<span class="dv">2</span>),</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Memory (system-wide)</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>    memory_total_bytes BIGINT,</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>    memory_used_bytes BIGINT,</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>    memory_usage_percent <span class="dt">NUMERIC</span>(<span class="dv">5</span>,<span class="dv">2</span>),</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Disk (all drives combined)</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>    disk_total_bytes BIGINT,</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>    disk_used_bytes BIGINT,</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>    disk_usage_percent <span class="dt">NUMERIC</span>(<span class="dv">5</span>,<span class="dv">2</span>),</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Network (all interfaces combined)</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>    net_bytes_sent_per_sec BIGINT,</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>    net_bytes_recv_per_sec BIGINT,</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    net_utilization_percent <span class="dt">NUMERIC</span>(<span class="dv">5</span>,<span class="dv">2</span>),</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>    net_packets_sent BIGINT,</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>    net_packets_recv BIGINT,</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>    net_errors BIGINT,</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    net_dropped BIGINT,</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Process count</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    process_count <span class="dt">INTEGER</span>,</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Collection metadata</span></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>    collection_duration_ms <span class="dt">INTEGER</span>,</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="kw">id</span>, <span class="dt">timestamp</span>),</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (device_id) <span class="kw">REFERENCES</span> devices(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>) <span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="kw">RANGE</span> (<span class="dt">timestamp</span>);</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a><span class="co">-- Indexes</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_users_username <span class="kw">ON</span> users(username);</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_refresh_tokens_hash <span class="kw">ON</span> refresh_tokens(token_hash);</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_devices_ip <span class="kw">ON</span> devices(ip);</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_devices_status <span class="kw">ON</span> devices(status);</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_device_creds_device <span class="kw">ON</span> device_credentials(device_id);</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_metrics_device_time <span class="kw">ON</span> metrics(device_id, <span class="dt">timestamp</span> <span class="kw">DESC</span>);</span></code></pre></div>
<h3 id="partitioning-strategy">5.3 Partitioning Strategy</h3>
<p>Monthly partitions for time-series data:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create partitions</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> metrics_y2025m01 <span class="kw">PARTITION</span> <span class="kw">OF</span> metrics</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">'2025-01-01'</span>) <span class="kw">TO</span> (<span class="st">'2025-02-01'</span>);</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> metrics_y2025m02 <span class="kw">PARTITION</span> <span class="kw">OF</span> metrics</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">'2025-02-01'</span>) <span class="kw">TO</span> (<span class="st">'2025-03-01'</span>);</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Automated partition creation (via cron or app)</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- Retention: DROP old partitions after 90 days</span></span></code></pre></div>
<hr>
<h2 id="message-queue-architecture">6. Message Queue Architecture</h2>
<h3 id="queue-selection-nats">6.1 Queue Selection:
<strong>NATS</strong></h3>
<table>
<colgroup>
<col style="width: 30%">
<col style="width: 18%">
<col style="width: 30%">
<col style="width: 21%">
</colgroup>
<thead>
<tr class="header">
<th>Criteria</th>
<th>NATS</th>
<th>RabbitMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Simplicity</td>
<td>High</td>
<td>Medium</td>
<td>Low</td>
</tr>
<tr class="even">
<td>Single binary</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr class="odd">
<td>Go native</td>
<td>Yes</td>
<td>Via AMQP</td>
<td>Via client</td>
</tr>
<tr class="even">
<td>Persistence</td>
<td>JetStream</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>Latency</td>
<td>Very Low</td>
<td>Low</td>
<td>Medium</td>
</tr>
<tr class="even">
<td>Setup</td>
<td>Embed or single binary</td>
<td>Erlang runtime</td>
<td>ZooKeeper + brokers</td>
</tr>
</tbody>
</table>
<p><strong>Justification:</strong> NATS with JetStream provides: -
Embeddable in Go (no external process required) - Simple pub/sub and
persistent queues - Low latency for real-time polling - Built-in
clustering (future scalability)</p>
<h3 id="queue-topics">6.2 Queue Topics</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                              Message Queues                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  nmslite.discovery.jobs                                             │    │
│  │  - Trigger: API POST /discover                                      │    │
│  │  - Consumer: Discovery Worker                                       │    │
│  │  - Payload: { subnet: "192.168.1.0/24" }                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  nmslite.poll.jobs                                                  │    │
│  │  - Trigger: Scheduler tick OR API manual poll                       │    │
│  │  - Consumer: Poll Workers (N concurrent)                            │    │
│  │  - Payload: { device_id, credential_id, scheduled_at }              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  nmslite.metrics.results                                            │    │
│  │  - Trigger: Poll Worker completion                                  │    │
│  │  - Consumer: Storage Writer                                         │    │
│  │  - Payload: { device_id, timestamp, metrics: {...} }                │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  nmslite.device.events                                              │    │
│  │  - Trigger: Status changes                                          │    │
│  │  - Consumer: Cache invalidator                                      │    │
│  │  - Payload: { device_id, event: "status_changed", new_status }      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="message-flow">6.3 Message Flow</h3>
<pre><code>┌──────────────────────────────────────────────────────────────────────────────┐
│                           Polling Flow                                       │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Scheduler                  Queue                    Workers                │
│      │                         │                         │                   │
│      │  Every polling_interval │                         │                   │
│      │─────────────────────────▶                         │                   │
│      │   Publish PollJob       │                         │                   │
│      │   to poll.jobs          │                         │                   │
│      │                         │                         │                   │
│      │                         │  Subscribe (N workers)  │                   │
│      │                         │◀────────────────────────│                   │
│      │                         │                         │                   │
│      │                         │  Deliver job            │                   │
│      │                         │─────────────────────────▶                   │
│      │                         │                         │                   │
│      │                         │                         │  Get credential   │
│      │                         │                         │  from cache       │
│      │                         │                         │        │          │
│      │                         │                         │        ▼          │
│      │                         │                         │  Connect to       │
│      │                         │                         │  Windows target   │
│      │                         │                         │        │          │
│      │                         │                         │        ▼          │
│      │                         │                         │  Collect metrics  │
│      │                         │                         │        │          │
│      │                         │                         │        ▼          │
│      │                         │  Publish MetricsResult  │                   │
│      │                         │◀────────────────────────│                   │
│      │                         │  to metrics.results     │                   │
│      │                         │                         │                   │
│                                                                              │
│   Storage Writer              Queue                                          │
│      │                         │                                             │
│      │  Subscribe              │                                             │
│      │◀────────────────────────│                                             │
│      │                         │                                             │
│      │  Batch insert to DB     │                                             │
│      │                         │                                             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘</code></pre>
<hr>
<h2 id="caching-architecture">7. Caching Architecture</h2>
<h3 id="cache-strategy">7.1 Cache Strategy</h3>
<p><strong>Type:</strong> Pure In-Memory (Go <code>sync.RWMutex</code> +
<code>map</code> with TTL expiration)</p>
<p>No external caching libraries. Simple, zero-dependency implementation
using standard library primitives.</p>
<table>
<colgroup>
<col style="width: 18%">
<col style="width: 15%">
<col style="width: 42%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Data</th>
<th>TTL</th>
<th>Invalidation</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Device metadata</td>
<td>5 min</td>
<td>On update event</td>
<td>Frequently read by polling</td>
</tr>
<tr class="even">
<td>Decrypted credentials</td>
<td>5 min</td>
<td>On update event</td>
<td>Avoid DB + decrypt on every poll</td>
</tr>
<tr class="odd">
<td>Latest metrics (per device)</td>
<td>30 sec</td>
<td>On new metrics</td>
<td>API reads for “current status”</td>
</tr>
</tbody>
</table>
<h3 id="cache-implementation">7.2 Cache Implementation</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Pure stdlib implementation - no external dependencies</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Cache <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    mu      sync<span class="op">.</span>RWMutex</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    devices <span class="kw">map</span><span class="op">[</span><span class="dt">int</span><span class="op">]*</span>cachedItem<span class="op">[</span>Device<span class="op">]</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    creds   <span class="kw">map</span><span class="op">[</span><span class="dt">int</span><span class="op">]*</span>cachedItem<span class="op">[</span>DecryptedCredential<span class="op">]</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    metrics <span class="kw">map</span><span class="op">[</span><span class="dt">int</span><span class="op">]*</span>cachedItem<span class="op">[</span>DeviceMetrics<span class="op">]</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> cachedItem<span class="op">[</span>T <span class="dt">any</span><span class="op">]</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    data      <span class="op">*</span>T</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    expiresAt time<span class="op">.</span>Time</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Example methods</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>c <span class="op">*</span>Cache<span class="op">)</span> GetDevice<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> id <span class="dt">int</span><span class="op">)</span> <span class="op">(*</span>Device<span class="op">,</span> <span class="dt">bool</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    c<span class="op">.</span>mu<span class="op">.</span>RLock<span class="op">()</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">defer</span> c<span class="op">.</span>mu<span class="op">.</span>RUnlock<span class="op">()</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    item<span class="op">,</span> ok <span class="op">:=</span> c<span class="op">.</span>devices<span class="op">[</span>id<span class="op">]</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">!</span>ok <span class="op">||</span> time<span class="op">.</span>Now<span class="op">().</span>After<span class="op">(</span>item<span class="op">.</span>expiresAt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ot">nil</span><span class="op">,</span> <span class="ot">false</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> item<span class="op">.</span>data<span class="op">,</span> <span class="ot">true</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>c <span class="op">*</span>Cache<span class="op">)</span> SetDevice<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> device <span class="op">*</span>Device<span class="op">,</span> ttl time<span class="op">.</span>Duration<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    c<span class="op">.</span>mu<span class="op">.</span>Lock<span class="op">()</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">defer</span> c<span class="op">.</span>mu<span class="op">.</span>Unlock<span class="op">()</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    c<span class="op">.</span>devices<span class="op">[</span>device<span class="op">.</span>ID<span class="op">]</span> <span class="op">=</span> <span class="op">&amp;</span>cachedItem<span class="op">[</span>Device<span class="op">]{</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>        data<span class="op">:</span>      device<span class="op">,</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>        expiresAt<span class="op">:</span> time<span class="op">.</span>Now<span class="op">().</span>Add<span class="op">(</span>ttl<span class="op">),</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>c <span class="op">*</span>Cache<span class="op">)</span> InvalidateDevice<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> id <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    c<span class="op">.</span>mu<span class="op">.</span>Lock<span class="op">()</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">defer</span> c<span class="op">.</span>mu<span class="op">.</span>Unlock<span class="op">()</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">delete</span><span class="op">(</span>c<span class="op">.</span>devices<span class="op">,</span> id<span class="op">)</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Design Rationale:</strong> - Zero external dependencies -
Full control over eviction logic - Sufficient for 100-500 devices scale
- Easy to understand, test, and debug - Background goroutine for
periodic cleanup of expired entries</p>
<h3 id="cache-invalidation-flow">7.3 Cache Invalidation Flow</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                           Cache Invalidation                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   API Handler                Service               Cache         Queue      │
│       │                         │                    │              │       │
│       │  Update Device          │                    │              │       │
│       │────────────────────────▶│                    │              │       │
│       │                         │                    │              │       │
│       │                         │  Update DB         │              │       │
│       │                         │────────▶           │              │       │
│       │                         │                    │              │       │
│       │                         │  Publish event     │              │       │
│       │                         │───────────────────────────────────▶       │
│       │                         │  (device.events)   │              │       │
│       │                         │                    │              │       │
│       │                         │                    │  Subscribe   │       │
│       │                         │                    │◀─────────────│       │
│       │                         │                    │              │       │
│       │                         │                    │  Invalidate  │       │
│       │                         │                    │  cache entry │       │
│       │                         │                    │              │       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<hr>
<h2 id="security-architecture">8. Security Architecture</h2>
<h3 id="authentication-flow">8.1 Authentication Flow</h3>
<pre><code>┌────────┐          ┌─────────┐          ┌──────────┐
│ Client │          │   API   │          │ Database │
└───┬────┘          └────┬────┘          └────┬─────┘
    │                    │                    │
    │ POST /auth/login   │                    │
    │ {user, password}   │                    │
    │───────────────────▶│                    │
    │                    │                    │
    │                    │ Verify bcrypt      │
    │                    │ Generate JWT       │
    │                    │                    │
    │ {access_token,     │                    │
    │  refresh_token,    │                    │
    │  expires_at}       │                    │
    │◀───────────────────│                    │
    │                    │                    │
    │ GET /api/devices   │                    │
    │ Auth: Bearer &lt;jwt&gt; │                    │
    │───────────────────▶│                    │
    │                    │                    │
    │                    │ Validate JWT       │
    │                    │ (signature+expiry) │
    │                    │                    │
    │ {devices: [...]}   │                    │
    │◀───────────────────│                    │</code></pre>
<h3 id="jwt-structure">8.2 JWT Structure</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"header"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"alg"</span><span class="fu">:</span> <span class="st">"HS256"</span><span class="fu">,</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"typ"</span><span class="fu">:</span> <span class="st">"JWT"</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"payload"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"sub"</span><span class="fu">:</span> <span class="st">"1"</span><span class="fu">,</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"username"</span><span class="fu">:</span> <span class="st">"admin"</span><span class="fu">,</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"role"</span><span class="fu">:</span> <span class="st">"admin"</span><span class="fu">,</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"iat"</span><span class="fu">:</span> <span class="dv">1733000000</span><span class="fu">,</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"exp"</span><span class="fu">:</span> <span class="dv">1733000900</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Token Lifetimes:</strong> - Access Token: 15 minutes -
Refresh Token: 7 days</p>
<h3 id="credential-encryption">8.3 Credential Encryption</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                    Credential Storage                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Input                 Encryption              Storage          │
│  ┌─────────────┐      ┌──────────────┐      ┌───────────────┐   │
│  │ password:   │─────▶│ AES-256-GCM  │─────▶│ encrypted_    │   │
│  │ "P@ssw0rd"  │      │ (master key) │      │ password      │   │
│  └─────────────┘      └──────────────┘      └───────────────┘   │
│                                                                 │
│  Master Key Source: NMSLITE_MASTER_KEY environment variable     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="tls-configuration">8.4 TLS Configuration</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">server</span><span class="kw">:</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tls</span><span class="kw">:</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">enabled</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cert_file</span><span class="kw">:</span><span class="at"> /etc/nmslite/tls/server.crt</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">key_file</span><span class="kw">:</span><span class="at"> /etc/nmslite/tls/server.key</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">min_version</span><span class="kw">:</span><span class="at"> </span><span class="st">"1.2"</span></span></code></pre></div>
<h3 id="security-checklist">8.5 Security Checklist</h3>
<table>
<thead>
<tr class="header">
<th>Control</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Password hashing</td>
<td>bcrypt (cost 12)</td>
</tr>
<tr class="even">
<td>Credential encryption</td>
<td>AES-256-GCM</td>
</tr>
<tr class="odd">
<td>Transport security</td>
<td>TLS 1.2+</td>
</tr>
<tr class="even">
<td>Token security</td>
<td>Short-lived JWT + refresh</td>
</tr>
<tr class="odd">
<td>Secret storage</td>
<td>Environment variables</td>
</tr>
<tr class="even">
<td>SQL injection</td>
<td>Parameterized queries (pgx)</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="api-specification">9. API Specification</h2>
<h3 id="endpoints-overview">9.1 Endpoints Overview</h3>
<pre><code>BASE URL: https://localhost:8443/api/v1

Authentication
  POST   /auth/login              Login, get tokens
  POST   /auth/refresh            Refresh access token

Credentials
  GET    /credentials             List all credentials
  POST   /credentials             Create credential
  GET    /credentials/:id         Get credential by ID
  PUT    /credentials/:id         Update credential
  DELETE /credentials/:id         Delete credential

Devices
  GET    /devices                 List all devices
  POST   /devices                 Create device
  GET    /devices/:id             Get device by ID
  PUT    /devices/:id             Update device
  DELETE /devices/:id             Delete device
  POST   /devices/discover        Discover devices in subnet
  POST   /devices/:id/provision   Provision monitoring
  POST   /devices/:id/deprovision Deprovision monitoring

Metrics
  GET    /devices/:id/metrics           Get latest metrics
  GET    /devices/:id/metrics/history   Get historical metrics

Health
  GET    /health                  Health check (no auth)</code></pre>
<h3 id="requestresponse-examples">9.2 Request/Response Examples</h3>
<h4 id="login">Login</h4>
<pre class="http"><code>POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "secret"
}</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"success"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"data"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"access_token"</span><span class="fu">:</span> <span class="st">"eyJhbGciOiJIUzI1NiIs..."</span><span class="fu">,</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"refresh_token"</span><span class="fu">:</span> <span class="st">"dGhpcyBpcyBhIHJlZnJlc2g..."</span><span class="fu">,</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"expires_at"</span><span class="fu">:</span> <span class="st">"2025-12-03T10:15:00Z"</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="create-credential">Create Credential</h4>
<pre class="http"><code>POST /api/v1/credentials
Authorization: Bearer &lt;access_token&gt;
Content-Type: application/json

{
  "name": "Windows Admin",
  "credential_type": "winrm_ntlm",
  "username": "administrator",
  "password": "P@ssw0rd123",
  "domain": "CORP",
  "port": 5985,
  "use_ssl": false
}</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"success"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"data"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"id"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"Windows Admin"</span><span class="fu">,</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"credential_type"</span><span class="fu">:</span> <span class="st">"winrm_ntlm"</span><span class="fu">,</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"username"</span><span class="fu">:</span> <span class="st">"administrator"</span><span class="fu">,</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"domain"</span><span class="fu">:</span> <span class="st">"CORP"</span><span class="fu">,</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"port"</span><span class="fu">:</span> <span class="dv">5985</span><span class="fu">,</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"use_ssl"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"created_at"</span><span class="fu">:</span> <span class="st">"2025-12-03T10:00:00Z"</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="provision-device">Provision Device</h4>
<pre class="http"><code>POST /api/v1/devices/1/provision
Authorization: Bearer &lt;access_token&gt;
Content-Type: application/json

{
  "credential_id": 1,
  "polling_interval": 60
}</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"success"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"data"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"device_id"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"status"</span><span class="fu">:</span> <span class="st">"provisioned"</span><span class="fu">,</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"message"</span><span class="fu">:</span> <span class="st">"Device provisioned for monitoring"</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="get-metrics">Get Metrics</h4>
<pre class="http"><code>GET /api/v1/devices/1/metrics
Authorization: Bearer &lt;access_token&gt;</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"success"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"data"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"device_id"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"timestamp"</span><span class="fu">:</span> <span class="st">"2025-12-03T10:05:00Z"</span><span class="fu">,</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"cpu"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"usage_percent"</span><span class="fu">:</span> <span class="fl">45.5</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"memory"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"total_bytes"</span><span class="fu">:</span> <span class="dv">17179869184</span><span class="fu">,</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"used_bytes"</span><span class="fu">:</span> <span class="dv">8589934592</span><span class="fu">,</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"usage_percent"</span><span class="fu">:</span> <span class="fl">50.0</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"disk"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"total_bytes"</span><span class="fu">:</span> <span class="dv">500107862016</span><span class="fu">,</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"used_bytes"</span><span class="fu">:</span> <span class="dv">250053931008</span><span class="fu">,</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"usage_percent"</span><span class="fu">:</span> <span class="fl">50.0</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"network"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"bytes_sent_per_sec"</span><span class="fu">:</span> <span class="dv">1048576</span><span class="fu">,</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"bytes_recv_per_sec"</span><span class="fu">:</span> <span class="dv">2097152</span><span class="fu">,</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"utilization_percent"</span><span class="fu">:</span> <span class="fl">25.0</span><span class="fu">,</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"packets_sent"</span><span class="fu">:</span> <span class="dv">1000000</span><span class="fu">,</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"packets_recv"</span><span class="fu">:</span> <span class="dv">2000000</span><span class="fu">,</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"errors"</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"dropped"</span><span class="fu">:</span> <span class="dv">5</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"process_count"</span><span class="fu">:</span> <span class="dv">142</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="error-response">Error Response</h4>
<div class="sourceCode" id="cb30"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"success"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"error"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"code"</span><span class="fu">:</span> <span class="st">"VALIDATION_ERROR"</span><span class="fu">,</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"message"</span><span class="fu">:</span> <span class="st">"Invalid IP address format"</span><span class="fu">,</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"details"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"field"</span><span class="fu">:</span> <span class="st">"ip"</span><span class="fu">,</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"value"</span><span class="fu">:</span> <span class="st">"999.999.999.999"</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<hr>
<h2 id="configuration">10. Configuration</h2>
<h3 id="configuration-sources-priority-order">10.1 Configuration Sources
(Priority Order)</h3>
<ol type="1">
<li><strong>Command-line flags</strong> (highest priority)</li>
<li><strong>Environment variables</strong></li>
<li><strong>Configuration file</strong> (lowest priority)</li>
</ol>
<h3 id="configuration-file">10.2 Configuration File</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># config.yaml</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">server</span><span class="kw">:</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">host</span><span class="kw">:</span><span class="at"> </span><span class="st">"0.0.0.0"</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8443</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">read_timeout</span><span class="kw">:</span><span class="at"> </span><span class="st">"30s"</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">write_timeout</span><span class="kw">:</span><span class="at"> </span><span class="st">"30s"</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tls</span><span class="kw">:</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">enabled</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cert_file</span><span class="kw">:</span><span class="at"> </span><span class="st">"/etc/nmslite/tls/server.crt"</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">key_file</span><span class="kw">:</span><span class="at"> </span><span class="st">"/etc/nmslite/tls/server.key"</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="fu">database</span><span class="kw">:</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">host</span><span class="kw">:</span><span class="at"> </span><span class="st">"localhost"</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">5432</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">"nmslite"</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">user</span><span class="kw">:</span><span class="at"> </span><span class="st">"nmslite"</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">password</span><span class="kw">:</span><span class="at"> </span><span class="st">"${DB_PASSWORD}"</span><span class="co">  # From env</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">max_open_conns</span><span class="kw">:</span><span class="at"> </span><span class="dv">25</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">max_idle_conns</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">conn_max_lifetime</span><span class="kw">:</span><span class="at"> </span><span class="st">"5m"</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="fu">auth</span><span class="kw">:</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">jwt_secret</span><span class="kw">:</span><span class="at"> </span><span class="st">"${JWT_SECRET}"</span><span class="co">  # From env</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">access_token_ttl</span><span class="kw">:</span><span class="at"> </span><span class="st">"15m"</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">refresh_token_ttl</span><span class="kw">:</span><span class="at"> </span><span class="st">"168h"</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">bcrypt_cost</span><span class="kw">:</span><span class="at"> </span><span class="dv">12</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="fu">queue</span><span class="kw">:</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> </span><span class="st">"nats"</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">url</span><span class="kw">:</span><span class="at"> </span><span class="st">"nats://localhost:4222"</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">embedded</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span><span class="co">  # Run embedded NATS server</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cache</span><span class="kw">:</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">device_ttl</span><span class="kw">:</span><span class="at"> </span><span class="st">"5m"</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">credential_ttl</span><span class="kw">:</span><span class="at"> </span><span class="st">"5m"</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">metrics_ttl</span><span class="kw">:</span><span class="at"> </span><span class="st">"30s"</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">cleanup_interval</span><span class="kw">:</span><span class="at"> </span><span class="st">"1m"</span><span class="co">  # Background cleanup of expired entries</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a><span class="fu">polling</span><span class="kw">:</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">default_interval</span><span class="kw">:</span><span class="at"> </span><span class="st">"60s"</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">worker_count</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">timeout</span><span class="kw">:</span><span class="at"> </span><span class="st">"30s"</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a><span class="fu">encryption</span><span class="kw">:</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">master_key</span><span class="kw">:</span><span class="at"> </span><span class="st">"${NMSLITE_MASTER_KEY}"</span><span class="co">  # From env</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a><span class="fu">logging</span><span class="kw">:</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">level</span><span class="kw">:</span><span class="at"> </span><span class="st">"info"</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">format</span><span class="kw">:</span><span class="at"> </span><span class="st">"json"</span></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">output</span><span class="kw">:</span><span class="at"> </span><span class="st">"stdout"</span></span></code></pre></div>
<h3 id="environment-variables">10.3 Environment Variables</h3>
<table>
<thead>
<tr class="header">
<th>Variable</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>NMSLITE_CONFIG</code></td>
<td>Config file path</td>
<td><code>./config.yaml</code></td>
</tr>
<tr class="even">
<td><code>NMSLITE_SERVER_PORT</code></td>
<td>Server port</td>
<td><code>8443</code></td>
</tr>
<tr class="odd">
<td><code>NMSLITE_DB_PASSWORD</code></td>
<td>Database password</td>
<td>-</td>
</tr>
<tr class="even">
<td><code>NMSLITE_JWT_SECRET</code></td>
<td>JWT signing secret</td>
<td>-</td>
</tr>
<tr class="odd">
<td><code>NMSLITE_MASTER_KEY</code></td>
<td>Credential encryption key</td>
<td>-</td>
</tr>
<tr class="even">
<td><code>NMSLITE_LOG_LEVEL</code></td>
<td>Log level</td>
<td><code>info</code></td>
</tr>
</tbody>
</table>
<h3 id="command-line-flags">10.4 Command-Line Flags</h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nmslite</span> <span class="dt">\</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--config</span> /etc/nmslite/config.yaml <span class="dt">\</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--server.port</span> 8443 <span class="dt">\</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--log.level</span> debug</span></code></pre></div>
<hr>
<h2 id="technology-stack">11. Technology Stack</h2>
<h3 id="core-dependencies">11.1 Core Dependencies</h3>
<table>
<colgroup>
<col style="width: 35%">
<col style="width: 29%">
<col style="width: 35%">
</colgroup>
<thead>
<tr class="header">
<th>Component</th>
<th>Library</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Language</strong></td>
<td>Go 1.21+</td>
<td>Performance, concurrency, single binary</td>
</tr>
<tr class="even">
<td><strong>HTTP Router</strong></td>
<td>chi</td>
<td>Lightweight, middleware support, idiomatic</td>
</tr>
<tr class="odd">
<td><strong>Database</strong></td>
<td>PostgreSQL 15+</td>
<td>Partitioning, JSONB support, reliability</td>
</tr>
<tr class="even">
<td><strong>DB Driver</strong></td>
<td>pgx/v5</td>
<td>Native Postgres, connection pooling</td>
</tr>
<tr class="odd">
<td><strong>Migrations</strong></td>
<td>golang-migrate</td>
<td>Version-controlled schema changes</td>
</tr>
<tr class="even">
<td><strong>JWT</strong></td>
<td>golang-jwt/jwt/v5</td>
<td>Standard JWT implementation</td>
</tr>
<tr class="odd">
<td><strong>Config</strong></td>
<td>viper</td>
<td>Multi-source config (file, env, flags)</td>
</tr>
<tr class="even">
<td><strong>Validation</strong></td>
<td>go-playground/validator</td>
<td>Struct tag validation</td>
</tr>
<tr class="odd">
<td><strong>Logging</strong></td>
<td>log/slog (stdlib)</td>
<td>Structured logging, zero deps</td>
</tr>
<tr class="even">
<td><strong>Queue</strong></td>
<td>nats-io/nats.go</td>
<td>Embedded or standalone, JetStream</td>
</tr>
<tr class="odd">
<td><strong>WinRM</strong></td>
<td>masterzen/winrm</td>
<td>WinRM protocol client</td>
</tr>
<tr class="even">
<td><strong>Encryption</strong></td>
<td>crypto/aes (stdlib)</td>
<td>AES-256-GCM for credentials</td>
</tr>
<tr class="odd">
<td><strong>Cache</strong></td>
<td>sync.RWMutex + map (stdlib)</td>
<td>Pure in-memory, zero external deps</td>
</tr>
</tbody>
</table>
<h3 id="project-structure">11.2 Project Structure</h3>
<pre><code>nmslite/
├── cmd/
│   └── nmslite/
│       └── main.go              # Entry point
├── internal/
│   ├── config/
│   │   └── config.go            # Configuration loading
│   ├── server/
│   │   └── server.go            # HTTP server setup
│   ├── handler/
│   │   ├── auth.go
│   │   ├── device.go
│   │   ├── credential.go
│   │   └── metrics.go
│   ├── service/
│   │   ├── auth.go
│   │   ├── device.go
│   │   ├── credential.go
│   │   ├── metrics.go
│   │   └── polling.go
│   ├── repository/
│   │   ├── user.go
│   │   ├── device.go
│   │   ├── credential.go
│   │   └── metrics.go
│   ├── collector/
│   │   ├── collector.go         # Interface
│   │   ├── registry.go          # Plugin registry
│   │   ├── wmi.go               # WMI collector
│   │   └── winrm.go             # WinRM collector
│   ├── queue/
│   │   ├── queue.go             # Interface
│   │   └── nats.go              # NATS implementation
│   ├── cache/
│   │   ├── cache.go             # Interface
│   │   └── memory.go            # In-memory implementation
│   ├── crypto/
│   │   └── crypto.go            # Encryption utilities
│   └── model/
│       ├── user.go
│       ├── device.go
│       ├── credential.go
│       └── metrics.go
├── migrations/
│   ├── 000001_init_schema.up.sql
│   └── 000001_init_schema.down.sql
├── api/
│   └── postman/
│       └── NMSlite.postman_collection.json
├── config/
│   └── config.example.yaml
├── go.mod
├── go.sum
└── README.md</code></pre>
<hr>
<h2 id="non-functional-requirements">12. Non-Functional
Requirements</h2>
<h3 id="performance-targets">12.1 Performance Targets</h3>
<table>
<thead>
<tr class="header">
<th>Metric</th>
<th>Target</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>API response (p95)</td>
<td>&lt; 100ms</td>
</tr>
<tr class="even">
<td>Metrics query (p95)</td>
<td>&lt; 500ms</td>
</tr>
<tr class="odd">
<td>Poll cycle</td>
<td>&lt; 30s per device</td>
</tr>
<tr class="even">
<td>Concurrent workers</td>
<td>10-50 configurable</td>
</tr>
</tbody>
</table>
<h3 id="scalability">12.2 Scalability</h3>
<table>
<thead>
<tr class="header">
<th>Dimension</th>
<th>Target</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Devices</td>
<td>100-500 (single instance)</td>
</tr>
<tr class="even">
<td>Metrics retention</td>
<td>90 days</td>
</tr>
<tr class="odd">
<td>Concurrent API requests</td>
<td>100/sec</td>
</tr>
</tbody>
</table>
<h3 id="security-requirements">12.3 Security Requirements</h3>
<table>
<thead>
<tr class="header">
<th>Requirement</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Authentication</td>
<td>JWT (access + refresh)</td>
</tr>
<tr class="even">
<td>Transport</td>
<td>HTTPS/TLS 1.2+</td>
</tr>
<tr class="odd">
<td>Credentials at rest</td>
<td>AES-256-GCM encrypted</td>
</tr>
<tr class="even">
<td>Secrets</td>
<td>Environment variables</td>
</tr>
</tbody>
</table>
<h3 id="observability">12.4 Observability</h3>
<table>
<thead>
<tr class="header">
<th>Aspect</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Logging</td>
<td>Structured JSON (slog)</td>
</tr>
<tr class="even">
<td>Log levels</td>
<td>debug, info, warn, error</td>
</tr>
<tr class="odd">
<td>Request tracing</td>
<td>Request ID in logs</td>
</tr>
<tr class="even">
<td>Health check</td>
<td>GET /health endpoint</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="appendix-a-glossary">Appendix A: Glossary</h2>
<table>
<thead>
<tr class="header">
<th>Term</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Device</strong></td>
<td>A Windows machine being monitored</td>
</tr>
<tr class="even">
<td><strong>Credential</strong></td>
<td>Authentication details for WMI/WinRM</td>
</tr>
<tr class="odd">
<td><strong>Provision</strong></td>
<td>Enable monitoring for a device</td>
</tr>
<tr class="even">
<td><strong>Poll</strong></td>
<td>Single metrics collection cycle</td>
</tr>
<tr class="odd">
<td><strong>Collector</strong></td>
<td>Plugin that gathers metrics from a device</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="appendix-b-decision-log">Appendix B: Decision Log</h2>
<table>
<colgroup>
<col style="width: 28%">
<col style="width: 31%">
<col style="width: 40%">
</colgroup>
<thead>
<tr class="header">
<th>Decision</th>
<th>Rationale</th>
<th>Alternatives</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>NATS queue</td>
<td>Embeddable, Go-native, simple</td>
<td>RabbitMQ, Kafka</td>
</tr>
<tr class="even">
<td>Pure in-memory cache</td>
<td>Zero deps, stdlib only, sufficient scale</td>
<td>ristretto, Redis</td>
</tr>
<tr class="odd">
<td>PostgreSQL</td>
<td>Partitioning, reliability</td>
<td>TimescaleDB, SQLite</td>
</tr>
<tr class="even">
<td>chi router</td>
<td>Lightweight, stdlib compatible</td>
<td>gin, echo</td>
</tr>
<tr class="odd">
<td>slog logging</td>
<td>Stdlib, structured, zero deps</td>
<td>zap, zerolog</td>
</tr>
<tr class="even">
<td>Flat metrics table</td>
<td>Single INSERT per poll, all scalar values, simple queries</td>
<td>JSONB arrays, normalized tables</td>
</tr>
<tr class="odd">
<td>System-wide aggregates</td>
<td>Simpler collection, smaller data, sufficient for health
monitoring</td>
<td>Per-disk/per-interface breakdown</td>
</tr>
<tr class="even">
<td>Process count only</td>
<td>Simpler, less data, privacy-friendly</td>
<td>Full process snapshots</td>
</tr>
</tbody>
</table>
<hr>
<p><strong>Document Revision History</strong></p>
<table>
<thead>
<tr class="header">
<th>Version</th>
<th>Date</th>
<th>Changes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1.0.0</td>
<td>Dec 2024</td>
<td>Initial architecture</td>
</tr>
</tbody>
</table>
</body></html>